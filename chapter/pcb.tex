\chapter{アナログ基板の設計と試作}

% MKIDの多重読み出しは、配線数を低減させ、それにより冷却光学系への熱流入を抑制することで、極低温での安定な動作を実現する。通信用として流通している市販品を用いることで、比較的簡単に読み出し系を構成することができる。しかし、市販品にはローパスフィルタが実装されているため透過特性が悪く、使用帯域が制限される。また、クロック生成器の周辺が必要以上に複雑なため、消費電力が大きく動作が不安定になるという問題がある。これらの問題を解決するために、広帯域かつシンプルな構成のADC/DACドーターボード（アナログボード）の開発を行った。

本章では、要求分析に基づいた仕様策定を行い、アナログ基板を設計する。また、市販のアナログ基板と比較した改良点についても整理し、試作したアナログ基板の概要をまとめる。

\section{要求分析}

前章で述べたように、市販のアナログ基板には三つの解決すべき課題があった。ひとつ目はローパスフィルターによる帯域の制限、ふたつ目は消費電力の過大、最後にユーザビリティの毀損である。

これらの三つの課題に対する解決方法は、次の通りである:
\begin{enumerate}
 \item DACの出力部分にあるローパスフィルターを排除する。
 \item 位相同期回路（PLL）の代わりにクロック・ファンアウト・バッファを用いる。
 \item 水晶発振器を整数倍の周波数のものに変更する。MMCXコネクターからSMAコネクターに変更する。
\end{enumerate}

1.は単純である。高周波をカットしているローパスフィルターを排除することで、ADCのサンプリング周波数の$1/2$まで帯域を使用可能にする。

2.は市販のアナログ基板に搭載されているICの中で最も消費電力が大きい部品であるPLL（Typ. 2.9 W）の代わりに、クロック・ファンアウト・バッファ（Typ. 0.29 W）を使うことで 2.5 W以上消費電力を抑制する。このクロック・ファンアウト・バッファは、PLLと異なりFPGAによる制御が不要であることも、利点のひとつである。また、ADCを同等の性能でより省電力なパッケージを選択した。

3.は周波数分解能を非直感的にする原因である水晶発振器を、ユーザーが使いやすい整数倍のクロックに変更する。これにより、ユーザーはある数（共振周波数）に12.288を掛けたり、割ったりするような認知的負荷から開放される。コネクターの統一も作業効率に改善をもたらす。

\section{仕様}

要求分析に基いて、新しいアナログ基板RHEA\footnote{RHEAは、「Rhea is a High spEed Analog board」の略で、南米に生息する陸鳥（ground bird）からその名を付けた。}の仕様を策定する。

図\ref{fig:rhea_schem}と表\ref{tbl:rhea_ic}にRHEAのブロック図と主要なICの仕様を示す。RHEAは2チャンネル14-bitのADCと2チャンネル16-bitのDACを搭載し、それぞれに水晶発振器から分配した200 MHzのクロックを入力する\footnote{このクロックはデジタル基板へも入力し、これをシステム・クロックとして使う。}。デジタル基板との接続はFMC LPC（Fpga Mezanine Card Low-Pin Count 160-pins）で行い、電源（12 V・3.3 V・2.5 V）もFMC LPCを介してデジタル基板から供給される。

% デジタル基板からADCとDACへのデータの受け渡しは、200 MHzのクロックを使った差動信号（LVDS）で行う。ただし、DACはDDR（Double Data Rate）でデータを読み書きするため、その倍の400 MHzのクロックをFPGA内でつくり使用する。

% ADCとDACのレジスターの読み書きはSPI（Serial Peripheral Interface）で制御する。SPIには書き込みと読み込みを一本の線で行うSPI 3-wireと書き込みと読み込みを別の線で行うSPI 4-wireがあり、DACはレジスター（cf., DAC Register config 23）を書き換えることでどちらか選ぶことができる（デフォルトではSPI 3-wire\footnote{ただし、DACのレジスター初期設定はデフォルトとは限らない。実際、RHEAに搭載したDACのレジスターはデフォルト値とはいくつか異なり、SPI制御は4-wireに設定されていた。}）。RHEAはADC/DAC共にSPI 4-wireで制御している。

\begin{figure}[htbp]
 \centering
 \includegraphics[width=12cm]{figures/rhea_schematic.pdf}
 \label{fig:rhea_schem}
 \caption{RHEAのブロック図}
\end{figure}

\begin{table}[htbp]
 \centering
 \label{tbl:rhea_ic}
 \caption{RHEAに搭載される主なICの仕様}
 \begin{tabular}{cc}\bhline{1.5pt}
  名前       & 特徴               \\\hline
  ADC        & 2 channel, 250 MSPS, 14-bit, SNR: 72.5 dBFS（$f_{\mathrm{in}}=70$ MHz） \\
  DAC        & 2 channel, 800 MSPS, 16-bit, NSD: 160 dBc/Hz（$f_{\mathrm{out}}80.1$ MHz）\\
  水晶発振器 & 200 MHz, LV-PECL, $t_{\mathrm{PJ}}=0.3$ ps Max.（$f_{\mathrm{OSC}} \gt 200$ MHz） \\\hline
 \end{tabular}
\end{table}

\section{設計}

RHEAは先に挙げた改良点以外は、基本的にFMC150を踏襲している。そのため、設計はFMC150から不必要な機能を取り除いて、それを整理するという方針で行った。

消費電力を減らすために、PLLに代えクロック・ファンアウト・バッファを搭載すること（図\ref{fig:clock_tree}）を既に述べたが、それにより電源回路のリニア・レギュレータ（3.8 Vから3.3 Vを降圧）がひとつ不要になった。また、その上流で12 Vから3.8 Vに降圧するスイッチング・レギュレータとその受動部品から構成される電源回路も見直した。他の実験で使われたことのある信頼性のあるICを用いることで、電源の安定化を図り、回路として簡素になった。

\begin{figure}[htbp]
 \centering
 \includegraphics[width=15cm]{figures/clock_tree.pdf}
 \label{fig:clock_tree}
 \caption{FMC150とRHEAにおけるクロック・ツリーの比較。クロック・ツリーに限って見れば消費電力はおよそ80\%（FMC150: 2.9 W + 0.25 W = 3.15 W、RHEA: 0.29 W + 0.33 W = 0.62 W）抑えられ、配線数は70\%以上（70本から20本）少なくなる。}
\end{figure}

\begin{figure}[htbp]
 \centering
 \includegraphics[width=15cm]{figures/power.pdf}
 \label{fig:power}
 \caption{RHEAではPLLへ供給していた3.3 Vの電源がなくなるため、リニア・レギュレータがひとつ不要になる。また、ADCも省電力タイプのものに変えたため、3.3 Vの電圧供給はDACのみとなる（その代わり、ADCへ供給する1.8 Vの電源がひとつ増える）。スイッチング・レギュレータはTPS5430から他の実験で信頼性のあるLMZ12001に変更した。}
\end{figure}

\section{試作}

\begin{figure}[htbp]
 \centering
 \includegraphics[width=12cm]{figures/rhea_dimensions.png}
 \label{fig:rhea_dim}
 \caption{RHEAの基板図}
\end{figure}
