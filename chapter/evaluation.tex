\chapter{試作アナログ基板の評価}

RHEAは従来のアナログ基板に対して3つの改善を行った。
1つ目は広帯域化、2つ目は消費電力の低減、3つ目がユーザビリティの向上である。
本章ではこれらの要求を満たしているか否かの評価を行う。

\section{クロック信号の確認}

試作基板の動作確認として、クロック信号の確認を行った。
4章で議論したように、信号は矩形波で伝送する。
クロック信号が矩形波としてみなせるか、
また仕様どおりの振幅や周波数をもつか、オシロスコープを用いて確認する
（クロックの分配は図\ref{fig:rhea_schem}のブロック図を参照）。

\subsection{基板納品時のトラブルとその解決}
\label{subsec:trouble}

納品された試作基板のクロック信号を確認するために、
カウンター回路をデジタル基板上のFPGAに実装し、
カウンターの上位ビットをLEDに出力して、
クロック信号の有無と大雑把な周波数を調べた（図\ref{fig:debug_led}）。

\begin{figure}[!h]
 \centering
 \includegraphics[width=14cm, trim=0 0 0 120, clip]{figures/debug_led.pdf}
 \caption[クロック信号の確認に使ったデジタル基板に実装されているLED]{クロック信号の確認に使ったデジタル基板に実装されているLED。28ビットのカウンターを用意し、その最上位ビットを出力することで、200 MHzのクロックであれば、おおよそ1秒（0.75 s）の周期でLEDが明滅する。}
 \label{fig:debug_led}
\end{figure}

調べたクロック信号は、
ADCのサンプリング・クロックとクロック・ファンアウト・バッファ
からのクロック（システム・クロック）で、
ともに200 MHzのクロック信号である。
しかし、LEDの明滅は、仕様のクロック信号から予想されるものと大きく異なった。
実装したカウンター回路は、一定周期でカウント・アップしておらず、
ADCのサンプリング・クロックとシステム・クロックも同期していなかった。

そこで、オシロスコープを用いてクロック信号の波形を確認した。
まず、クロック信号を生成している水晶発振器の出力をプローブすると、
200 MHz周期のクロック信号が確認できた。
次に、クロック・ファンアウト・バッファの出力をプローブしてみると、
グラウンドのノイズを増幅したような信号が見えるだけで、
クロック信号とは異なることが判明した。

\begin{figure}[!h]
 \centering
 \includegraphics[width=14cm, trim=0 70 0 50, clip]{figures/lvds_lvpecl.pdf}
 \caption[納品時の水晶発振器]{納品時の水晶発振器（左）と回路図の該当箇所（右）。指定した回路図と異なる規格の発振器が実装されていた。}
 \label{fig:lvds_lvpecl}
\end{figure}

クロック・ファンアウト・バッファは、信号規格によって配線方法が異なる。
たとえば、RHEAで使用するADCとDACの入力クロックの信号規格は、LV-PECLである。
したがって、クロック・ファンアウト・バッファは、
LV-PECLのクロック信号を入力し、同規格の信号を3つに分配して出力する
設計になっている。データシートを確認したところ、
基板上のクロック・ファンアウト・バッファの配線方法は、LV-PECLになっており、
この部分に問題がないことがわかった。

クロック・ファンアウト・バッファが正しく動作していることがわかったため、
消去法で水晶発振器をもう一度目視精査した。
すると、水晶発振器の型番が回路図のものと異なっていることが判明した
（図\ref{fig:lvds_lvpecl}）。納品時に実装されていた水晶発振器の信号規格が、
LVDSという信号規格であったため、正規の信号が出力されていなかった。
（つまり、製作会社のケアレス・ミスであった。）

このトラブルは、水晶発振器を回路図どおりのものに替えることで解決した
\footnote{水晶発振器の取り外しと再実装は、KEKの池野正弘氏に行っていただいた。この場をかりて、感謝の意を表したい。}。
水晶発振器のICピンは、全部で6本あり、半田面は1.6 mm $\times$ 1.5 mm、
ピン同士の間隔は最小で2.54 mmとADCやDACなどの他のICと比較して
ピン同士の間隔マージン大きいため、比較的簡単にICの交換ができる。
これについては、本章最後の「さらなる高みを目指した改造案の検討」
にも関係する。

LEDでの確認と共に、図\ref{fig:clock}と図\ref{fig:osc_probe}に、
水晶発振器の交換後にオシロスコープで測定したクロック信号と
その測定方法を示す。すべてのクロックが正しく出力されていることが確認できる。
ここで、全体的に波形が歪んでおり矩形波に見えないのは、
差動信号の一端を開放し、もう一方をパッシブ・プローブで計測しているためである。
通常、オシロスコープで差動信号を計測するには、パッシブ・プローブではなく、
差動プローブを用いる必要がある。
ここでは水晶発振器を交換したことによるクロック信号の変化を確認することが
目的であるため、このような構成で測定を行った。

\begin{figure}[!h]
 \centering
 \includegraphics[width=15cm]{figures/clock.pdf}
 \caption[オシロスコープで測定した基板上の各場所におけるクロック信号]{オシロスコープで測定した基板上の各場所におけるクロック信号。(a) 水晶発振器のクロック信号。(b) ADCへ入力しているクロック信号。(c) クロック・ファンアウト・バッファへ入力しているクロック信号。(d) ADCのサンプリング・クロック信号。(e) クロック・ファンアウト・バッファからFMCへのクロック信号（システム・クロック）。(f) DACへ入力しているクロック信号。全体的に、波形が歪んでおり矩形波に見えないが、これは差動出力の一端とグラウンドをパッシブ・プローブで測定しているためである。つまり差動信号の一端が開放されているためにコモン・モードが安定せず、反射の影響が見えている。本来、オシロスコープで差動信号を読む際は、差動プローブを用いて測定する。ここでは、水晶発振器を交換したことによるクロック信号の変化を確認することが目的であるため、図\ref{fig:osc_probe}のような構成で測定を行った。}
 \label{fig:clock}
\end{figure}

\clearpage

\begin{figure}[!h]
 \centering
 \includegraphics[width=14cm]{figures/osc_probe.pdf}
 \vspace{-5mm}
 \caption[オシロスコープでプローブした場所]{オシロスコープでプローブした場所。クロック信号は差動信号であるため、通常は差動プローブを用いて測定する。ここでの目的は、ICを交換したことによる大雑把な信号の確認であるため、一方の差動信号は開放してパッシブ・プローブで測定している。}
 \label{fig:osc_probe}
\end{figure}

\subsection{水晶発振器の動作確認}

上述のように、水晶発振器を交換したことで信号の有無と大雑把な周波数を確認した。
しかし、先の方法では波形の歪みが、開放端による反射の影響なのか、
クロック抜け（つまり、水晶発振器の不良）であるか区別がつかない。
そこで、FPGAに入力するクロック（図\ref{fig:clock}(d)、(e)）を使って
アナログ基板上の水晶発振器
（Epson, EG-2102CA\footnote{{\tt http://www.epsondevice.com/docs/qd/ja/DownloadServlet?id=ID000768}}）
がデータシートの仕様であるか否か確認する。

\subsubsection{確認方法}

\ref{subsec:trouble}で使用したデバック用LEDと28ビットカウンターを用いて、
ADCから出力するクロック（図\ref{fig:clock}(d)）と
クロック・ファンアウト・バッファからのクロック（図\ref{fig:clock}(e)）を
基準クロック（Kintex-7評価キットに搭載される200 MHzのシステム・クロック）
と比較する（図\ref{fig:check_clock}）。
これらのクロックを一定時間カウント・アップして、
水晶発振器が仕様書の示す周波数許容範囲（$\pm 100\times 10^{-6}$）
内であれば、アナログ基板上の水晶発振器に問題はない。

\begin{figure}[!h]
 \centering
 \includegraphics[width=9cm]{figures/check_clock.pdf}
 \vspace{-5mm}
 \caption{アナログ基板上の水晶発振器の動作確認}
 \label{fig:check_clock}
\end{figure}

\subsubsection{確認結果}

およそ1日間カウンターを放置して、アナログ基板上のクロック
（ADCから出力するクロックと
クロック・ファンアウト・バッファから出力するクロック）
を比較した結果、
アナログ基板上のクロックは、同期しており、
これらと基準クロックとのずれは仕様書にある許容周波数の範囲内
$\sigma_{\mathrm{RHEA}} \sim 10^{-5} < \sigma_{\mathrm{spec}} = 10^{-4}$
に収まっていた。
したがって、水晶発振器は正常に動作していることを確認した。

\section{消費電力の評価}

表\ref{tbl:rhea_ic}で示したように、RHEAはPLLの排除や電源回路の見直し、
ADCの省電力版への変更により、大幅に消費電力を削減する狙いがある。
そこで、直流電源とそれに内蔵する電流計を用いて
従来のアナログ基板とRHEAとで消費電力の比較を行う。

\subsection{評価方法}

消費電力の測定は、図\ref{fig:measure_power_schem}のようにして行う。
アナログ基板の電源は、FMCを介してデジタル基板から供給される。
デジタル基板は、通常AC100 Vから、ACアダプターでDC12 Vに変換している。
本測定では、直流電源で12 Vをつくり、その電流量をモニターして、
デジタル基板とアナログ基板の総消費電力を計算する。そして、
その値からデジタル基板（アナログ基板を抜いて測定）の消費電力を差し引いて、
アナログ基板の消費電力を算出した。

\begin{figure}[!h]
 \centering
 \includegraphics[width=10cm]{figures/measure_power_schem.pdf}
 \caption[消費電力を測定するための装置構成]{消費電力を測定するための装置構成。デジタル基板に供給するDC12 Vを電流計の付いた直流電源から供給し、デジタル基板に流れた電流量を測定する。直流電源からデジタル基板間で発生する電圧降下を較正するために、デジタル基板上の12 Vのピンとグラウンド・ピンの電圧差をテスターで測定する。}
 \label{fig:measure_power_schem}
\end{figure}

図\ref{fig:measure_power_schem}のテスターは、
直流電源とデジタル基板間で発生する電圧降下を較正するために、
デジタル基板上の12 Vのピンとグラウンド・ピンの電圧差をテスターで測定し、
すべての測定で12 Vの一定電圧が印加されるようにする。
図\ref{fig:measure_power}に、実際の測定構成の写真を示す。

\begin{figure}[!h]
 \centering
 \includegraphics[width=14cm]{figures/measure_power.pdf}
 \caption{RHEAの消費電力の測定}
 \label{fig:measure_power}
\end{figure}

\subsection{評価結果}

表\ref{tbl:power}にデジタル基板の消費電力を差し引いた
それぞれのアナログ基板の消費電力の比較をまとめる。
「状態」は読み出し系の動作状態を表す。
仕様策定の目標値である「従来の消費電力の半分」が達成されていることがわかる。

\begin{table}[htbp]
 \centering
 \caption{RHEA（本研究）とFMC150（既存の市販品）の消費電力の比較}
 \label{tbl:power}
 \begin{tabular}{cccc}
  \toprule
  \multirow{2}{*}{状態} & \multicolumn{2}{c}{消費電力 [W]} & \multirow{2}{*}{電力比（RHEA/FMC150）} \\
                   & RHEA & FMC150 &      \\\hline
  待機状態         & 1.8  & 5.9    & 0.31 \\
  読み出し多重度1  & 4.7  & 11.4   & 0.41 \\
  読み出し多重度32 & 7.9  & 15.1   & 0.52 \\
  \bottomrule
 \end{tabular}
\end{table}

\section{基板上ICの発熱量の評価}

図\ref{fig:fan}で示したように、従来のアナログ基板は排熱処理が必須である。
一般に、消費電力の大きいICは、発熱量も大きくなる。したがって、
消費電力の改善を行ったRHEAは、従来よりも発熱量が小さくなると期待される。
そこで、両者の基板表面温度を測定し比較する。

\subsection{評価方法}

赤外線サーモグラフィ（Keysight, U5855A）を使って、
アナログ基板を含めたフロントエンド回路の基板表面温度を計測する。
その際、フロントエンド回路の状態を「読み出し多重度32」に設定して、
基板上のICの温度が一定になるまで待ち測定を行う。
冷却ファンによる排熱を行った場合とそうでない場合の二通りを測定した。
ただし、FMC150においてファンなしの場合は、
温度が一定になる前にICが熱破損する可能性があるため、
基板表面温度の最大値が70\degree Cを超えた段階で測定を中断した。

\subsection{評価結果}

RHEAとFMC150の基板表面温度の測定結果を図\ref{fig:thermography}に示す。
RHEAの基板表面温度がFMC150のそれに比べて、
ほとんどすべての場所で20--30\degree C以上小さいことが確認できる。
また、RHEAはファンなしの状態でも基板表面の最高温度が40\degree C
を超えていないことがわかる。したがって、
RHEAは冷却ファンなしで安定に動作する。
これは読み出し系の簡素化の点からも大きな進展である。

\begin{figure}[!h]
 \centering
 \includegraphics[width=15cm]{figures/thermography.pdf}
 \caption[赤外線サーモグラフィによるRHEA（本研究）とFMC150（既存の市販品）の基板表面温度の比較]{赤外線サーモグラフィによるRHEA（本研究）とFMC150（既存の市販品）の基板表面温度の比較。RHEAとFMC150のファンあり・ファンなしをそれぞれ比較すると、どちらにおいてもRHEAの基板表面温度の方が小さいことが確認できる。また、FMC150ファンあり(a)とRHEAファンなし(d)を比較しても、RHEAの方が表面温度が小さいことがわかる。FMC150ファンなし(b)以外の測定は、温度が安定するまで1--2分待った後の測定結果である。一方、(b)においては、ICが熱破損する温度まであげるわけにはいかないので、基板の最高表面温度が70 \degree Cを超えた段階で測定を中断している（ファンのスイッチを切ったのち、僅か十秒程度）。}
 \label{fig:thermography}
\end{figure}

\clearpage

\section{帯域の評価}

図\ref{fig:lpf_circuit}で示したように、
RHEAには帯域を制限するLPF（ローパス・フィルター）が存在しない。
そこで、実際に100 MHzまでDACの信号強度が減衰しないことを
オシロスコープを用いて測定し、帯域の拡大を確認する。

\subsection{評価方法}

信号強度の測定は、図\ref{fig:measure_dac_output}のようにして行う。
デジタル基板上のFPGAで、MHz帯の正弦波と余弦波のデジタル信号を生成する。
生成したデジタル信号は、FMCを介してアナログ基板上のDACに送り、
DACでデジタル信号をアナログ信号に変換する。
そして、そのアナログ信号の強度をオシロスコープで測定する。
実際に測定している様子を図\ref{fig:measure_dac_output_rhea}に示す。

\begin{figure}[!h]
 \centering
 \includegraphics[width=12cm]{figures/measure_dac_output.pdf}
 \caption[DACの信号強度の評価方法]{DACの信号強度の評価方法。デジタル基板とアナログ基板はFMCで接続する。DACの信号は同軸ケーブルを伝ってオシロスコープに入る。}
 \label{fig:measure_dac_output}
\end{figure}

\begin{figure}[!h]
 \centering
 \includegraphics[width=14cm]{figures/measure_dac_output_rhea.pdf}
 \caption{RHEAで1 MHzの正弦波と余弦波を測定している様子}
 \label{fig:measure_dac_output_rhea}
\end{figure}

信号強度$P$は、
出力した正弦波（余弦波）の最大値と最小値の電圧差$V_{\mathrm{pp}}$を測定し、
次の式でエネルギーに変換する。
\begin{equation}
 P = 10\log_{10}\left({V_{\mathrm{pp}}^{2} \over R} \times {1\over 1000}\right) \quad \mathrm{[dBm]}
\end{equation}
ここで、$R$は終端抵抗を表し、$R=$ 50 $\Omega$である。

\subsection{評価結果}

図\ref{fig:comp_dac_output}にRHEAとFMC150のDACからの信号強度の比較を示す。
FMC150ではLPFにより、高周波数領域において、その信号強度が減衰していた。一方、
RHEAは高周波領域においても高い信号強度を維持している。

\begin{figure}[!h]
 \centering
 \includegraphics[width=12cm]{figures/dac_output_fmc150.png}
 \caption[RHEA（本研究）とFMC150（既存の市販品）におけるDACの信号強度の比較]{RHEA（本研究）とFMC150（既存の市販品）におけるDACの信号強度の比較。RHEAは高周波領域においてもで信号強度を維持している。数十kHzまでの直流成分はAC結合しているため、両者とも信号強度が弱い。AC結合は信号のベースラインのドリフトを防ぐので、このような高周波回路には必須である。}
 \label{fig:comp_dac_output}
\end{figure}

\clearpage

\section{評価結果まとめ}

以上より、評価結果をまとめると次のようになる:
\begin{enumerate}
 \item 帯域は$\pm$100 MHzに広がり、従来よりおよそ30\%広帯域化した。
 \item 消費電力は、読み出し多重度32の状態で7.9 Wであり、
       従来のおよそ半分になった。
 \item 発熱量を抑制し、外部冷却ファンが不要になった。また、
       コネクター規格をSMAに統一したことや基板の固定構造の実装、
       ユーザーが使用しやすいクロック周波数への変更等、
       ユーザビリティが飛躍的に向上した。
\end{enumerate}

今後、実際にMKIDを使って使用実績を積み重ねてくことが重要な課題であるが、
ひとまず、GroundBIRD実験のフロントエンド回路として、
要求を満たすことを確認した。

\section{さらなる高みを目指した改造案の検討}
\label{sec:kai}

アナログ基板RHEAのさらなる改造案（RHEA改; 図\ref{fig:rhea_kai}）として、
ADCとDACのサンプリング周波数をより高くすることが考えられる。
RHEAに搭載しているADC（ADS4249）とDAC（DAC3283）
の最大サンプル・レートはそれぞれ、250 MSPSと800 MSPSである。
つまり、RHEAにはあと25 MHz（実効的には50 MHz）翼を広げる余地がある。

\begin{figure}[htbp]
 \centering
 \includegraphics[width=11cm]{figures/rhea_kai.pdf}
 \caption{RHEAのさらなる改造により到達する境地}
 \label{fig:rhea_kai}
\end{figure}

\subsection{水晶発振器を交換してADC/DACのサンプリング周波数をあげる}

ADCとDACのサンプリング周波数は読み出し系の帯域を決定する大きな要素である。
そこで、これらのサンプリング周波数をADCの最大サンプリング・レートである
250 MHzにする。つまり、水晶発振器の周波数を250 MHzに変更する。
これにより、帯域を125 MHzまで拡大する。

この水晶発振器の変更は、\ref{subsec:trouble}「基板納品時のトラブルと解決」
で述べたように、半田ごてを使えば現在のRHEAを使って行うことができるため、
比較的簡単に試すことができる。

\subsection{DACのサンプリング周波数をさらに上げる}

DAC3283には出力波形をそれぞれ2倍、4倍に補完する機能が実装されている。
RHEAではこの補完機能は使用していないが、
DACのサンプリング周波数を200 MHzから800 MHzにすることで、
最大4倍の補完機能を使用することが可能となる。
これにより、高周波でもよりなめらかな波を生成することが可能となり、
ノイズ耐性を向上できる。

4倍の補完機能を実装するために必要な変更は次のふたつである:
\begin{enumerate}
 \item 水晶発振器の周波数を200 MHzから800 MHzにする。
 \item クロック・ファンアウト・バッファを分周器機能付きのものにする。
\end{enumerate}

前款で述べたように、1.は比較的簡単に変更することができる。
一方、2.は水晶発振器が出力した800 MHzのクロック信号をDACにはそのまま入力し、
ADCとFPGAには4分周（200 MHz）して入力する。たとえば、
Texas Instrumentsの
CDCM1804\footnote{http://www.ti.com/lit/ds/symlink/cdcm1804.pdf}
を使うとこの回路を実現することができる。ただし、
この変更は回路図の変更を要し、新しい基板を作りなおす手間を伴う。
